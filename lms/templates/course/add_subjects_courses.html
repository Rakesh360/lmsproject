{%extends 'base.html'%}
{% block start %}


<style type="text/css">
    .bg-1 {
        background: #ECECF8;
    }
</style>
<div class="section-header">
    <h1>Add Lessons to Package</h1>
    <div class="section-header-breadcrumb">
        
    </div>
</div>
<div id="main_id">
    <div class="card mt-5">
        {% include "utils/alert.html" %}
        <div class="card-header bg-primary text-white">
            <h4 class="text-white">ADD ITEMS</h4> 
            <div class="card-header-action">
                <a class="btn btn-success" href="{% url 'course_tree'  course_package_uid %}">
                View Tree </a>
            </div>
        </div>
        <div class="collapse show" id="mycard-collapse" style="">
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label>Select Subject</label>
                        <div class="input-group ">
                            <select id="subject" onchange="getChapters(0)" class="form-control">
                                <option selected>Choose</option>
                                {% for subject in subjects%}
                                <option value="{{subject.uid}}" {% if subject.uid == selected_subject %} selected
                                    {% endif %}>{{subject.subject_title}}</option>
                                {%  endfor %}
                            </select>
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group col-md-8">
                        <label>Select Chapter</label>
                        <div class="input-group ">
                            <select id="chapter" onchange="getLessons()" class="form-control">
                                <option>Choose</option>
                            </select>
                        </div>
                    </div>
                    

                    <div class="col-md-12">

                        <table class="table table-striped" id="table">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">S.no</th>
                                    <th scope="col">Lesson title</th>
                                    <th scope="col">Is Free</th>
                                    <th scope="col">Lesson type</th>
                                    <th scope="col">Created At</th>
                                    <th scope="col">Links</th>

                                </tr>
                            </thead>
                            <tbody>
                                {% for  lesson in lessons %}
                                <tr>
                                    <th scope="row">
                                        <input type="checkbox" {% if lesson.uid in old_lessons  %} checked {% endif %} class="lesson_list" data-lesson_id="{{lesson.uid}}">
                                    </th>

                                    <td>{{forloop.counter}}</td>
                                    <td>{{lesson.lesson_title}}</td>
                                    <td>{{lesson.is_free}}</td>
                                    <td>
                                       {{lesson.lesson_type}}
                                    </td>
                                    <td>{{lesson.created_at}}</td>


                                    <td>
                                        {% if lesson.lesson_type  %}
                                        <a href="{{lesson.video.video_link}}" class="btn btn-info btn-sm" target="_blank">View</a>
                                        {% else %}
                                        <a href="{{lesson.document.document_file}}" class="btn btn-info btn-sm" target="_blank">View</a>
                                       
                                        {% endif %}
                                    </td>
                                                          


                                </tr>
                                {%  endfor  %}
                               
                            </tbody>
                        </table>
                    </div>


                </div>
            </div>





            <button onclick="saveSubject()" class="btn btn-dark mt-3 mb-4 ml-4">
                Save Subject
            </button>


        </div>


    </div>

</div>



<script>

    {% if selected_subject %}
            getChapters()
    {% endif %}



    $(document).ready(function() {
    $('#table').DataTable( {
        "scrollY":        "200px",
        "scrollCollapse": true,
        "paging":         false
    } );
} );
  
// $(document).ready(function() {
//     $('#table').DataTable();
// } );

    let one = document.querySelector('#container1')
    let two = document.querySelector('#container2')
    var course_package_uid = '{{course_package_uid}}'
    var CSRF_TOKEN = '{{csrf_token}}'


    function addLessonToChapter(subject_uid, chapter_uid, lesson_uid) {
        var payload = {
            'subject_uid': subject_uid,
            'chapter_uid': chapter_uid,
            'lesson_uid': lesson_uid,
            'course_package_uid': course_package_uid
        }
       
        const headers = {
            'X-CSRFToken': CSRF_TOKEN
        }

        axios.post('/api/courses/save-course-package/', payload, {
                headers: headers
            })
            .then(function (response) {
                console.log(response);
            })
            .catch(function (error) {
                console.log(error);
            });




    }

    function getUid(){
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('uid');
    }


    function getChapters(v = 1) {
        if(v == 0){
            clearTable()
        }
        var subject = document.getElementById('subject').value
        axios.get(`/api/courses/get-chapters/?uid=${subject}`)
            .then(response => {
                console.log(response)

                var chapters = response.data.data
                $("#chapter").empty();
                var opt = document.createElement('option');

                opt.innerHTML = 'Choose';
                document.getElementById('chapter').appendChild(opt);
                for (var i = 0; i < chapters.length; i++) {
                    var opt = document.createElement('option');
                    console.log(chapters[i].uid)
                    opt.value = chapters[i].uid;
                    opt.innerHTML = chapters[i].chapter_title;
                    
                    if(chapters[i].uid == getUid()){
                    opt.setAttribute('selected', true);
                    }

                    document.getElementById('chapter').appendChild(opt);
                }
            })
    }

    function getLessons() {
        var chapter = document.getElementById('chapter').value
        window.location.href = `?uid=${chapter}`
        return;
    }

    function clearTable(){
        document.getElementById('table').innerHTML =''
    }


    function saveSubject() {
        swal({
                title: "Are you sure?",
                text: "You want to save?",
                icon: "success",
                buttons: true,
                dangerMode: true,
            })
            .then((willDelete) => {
                if (willDelete) {

                    var payload = {}

                    var lesson_elements =  document.querySelectorAll('.lesson_list')
                    var selected_lessons = []
                    var unselected_lessons = []
                    for(var i = 0;i<lesson_elements.length;i++){
                        if(lesson_elements[i].checked){
                            selected_lessons.push(lesson_elements[i].dataset.lesson_id)
                        }else{
                            unselected_lessons.push(lesson_elements[i].dataset.lesson_id)
                        }
                    }


                    var chapter = document.getElementById('chapter').value
                    var subject = document.getElementById('subject').value
                    var course_pacakage_uid = '{{course_package_uid}}'

                    var payload = {
                        'course_package_uid': course_package_uid,
                        'subject_uid': subject,
                        'chapter_uid': chapter,
                        'selected_lesson_uid': selected_lessons,
                        'unselected_lesson_uid' : unselected_lessons,
                    }
                    const headers = {
                        'X-CSRFToken': CSRF_TOKEN
                    }

                    console.log(payload)

                    axios.post('/api/courses/save-course-package/', payload, {
                            headers: headers
                        })
                        .then(function (response) {
                            console.log(response)
                            
                            window.location.reload()

                        })
                        .catch(function (error) {
                            console.log(error);
                        });

                } else {
                    swal("Your imaginary file is safe!");
                }
            });


       

    }

 


    function getSelectedValues() {
        var selectedVal = $("#multiselect").val();
        for (var i = 0; i < selectedVal.length; i++) {
            function innerFunc(i) {
                setTimeout(function () {
                    location.href = selectedVal[i];
                }, i * 2000);
            }
            innerFunc(i);
        }
    }
</script>


{% endblock %}

