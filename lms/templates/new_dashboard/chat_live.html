{% extends "base.html" %}
{% block start %}
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-firestore.js"></script>


<div class="container py-5 px-4">

    <div style="margin: 0 auto; font-size: xxx-large;">
        Live Chat
    </div>
    

    <div class="row overflow-hidden" id="people_online">

    </div>

    <div class="row rounded-lg overflow-hidden shadow">
        <!-- Users box-->

        <!-- Chat Box-->
        <div class="col-12 px-0">
            <div class="px-4 py-5 chat-box bg-white" id="chat_ui">


            </div>

            <!-- Typing area -->
            <form action="#" id="messageForm" class="bg-light">
                <div class="input-group">
                    <input type="text" id="message" placeholder="Type a message" aria-describedby="button-addon2"
                        class="form-control rounded-0 border-0 py-4 bg-light">
                    <div class="input-group-append" >
                        <button id="send-btn" type="submit" class="btn btn-link">
                            <img style="height:30px" src="https://img.icons8.com/ios/452/sent.png"></button>
                    </div>
                </div>

            </form>
        </div>
    </div>


<script>
    // Import the functions you need from the SDKs you need

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
    const msgScreen = document.getElementById('chat_ui');
    const msgFrom = 'Sender'
    const msgInput = document.getElementById('message');
    const msgBtn = document.getElementById('send-btn');
    const msgForm = document.getElementById('messageForm');
    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBU9QQ8-tfQjWBewvOIIw9ruP-01NXaj2g",
        authDomain: "malaviya-acedemy.firebaseapp.com",
        projectId: "malaviya-acedemy",
        databaseURL : "malaviya-acedemy.firebaseio.com",
        storageBucket: "malaviya-acedemy.appspot.com",
        messagingSenderId: "176187494863",
        appId: "1:176187494863:web:eba4d28c0683c7e96882ba"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  //  const usersRef = db.child('chatRoom');
   // const msgRef = usersRef 
    const room_id = "{{room_id}}"
    console.log("/{{room_id}}")
    //const msgRef = db.ref('/{{room_id}}');

   // usersRef.on("child_added", snap => {
//     let user = snap.val();
//     let li = document.createElement("li");
    
// });

    let name="";
    function init() {
        name = prompt("Please enter your name");
    }
    //document.addEventListener('DOMContentLoaded', init);


    msgForm.addEventListener('submit', function sendMessage(e){
        console.log('ck')
        e.preventDefault();
        const text = msgInput.value;

        if(!text.trim()) return alert('Please type a message'); //no msg submitted
        const msg = {
            name: 'Teacher',
            text: text
        };

        db.collection("chatRoom").doc(room_id).set({
            name: 'Teacher',
            text: "Hello"
     })
     .then(function() {
         console.log("Doc successful");
     })
     .catch(function(error) {
        console.error("Error writing doc", error);
     });


        return
        const usersRef = dbRef.child(`chatRoom/${room_id}`);
        msgRef.push(msg);
        msgInput.value = "";
    });


    
    const updateMsgs = data =>{
        const {dataName, text} = data.val(); //get name and text
        
        //load messages, display on left if not the user's name. Display on right if it is the user.
        const msg = `<li class="${dataName == name ? "msg my": "msg"}"><span class = "msg-span">
            <i class = "name">${name}: </i>${text}
            </span>
            </li>`
            
        msgScreen.innerHTML += msg; //add the <li> message to the chat window
            
            //auto scroll to bottom
            //document.getElementById("chat-window").scrollTop = document.getElementById("chat-window").scrollHeight;
    }
    //usersRef.on('child_added', updateMsgs);
    // const app = initializeApp(firebaseConfig);
    // console.log(app)

    // const db = getDatabase(app);

    console.log(db)

</script>


  
    <!-- 
    <script>
        var url = 'ws://13.232.227.45/ws/room/{{room_id}}/'
        var room_id = "{{room_id}}"
        console.log(url)
        var current_user_id = parseInt('{{request.user.id}}')
        var socket = new WebSocket(url)

        socket.onopen = function (e) {
            console.log('Connected')
        }

        socket.onmessage = function (e) {
            var data = JSON.parse(e.data)
            console.log(data.payload)


            if (data.payload.type) {
                if (data.payload.type == 'connected') {

                } else if (data.payload.type == 'disconnected') {
                    remove_online(data.payload.user_id)
                } else if (data.payload.type == 'message') {
                    addMessageToUi(data.payload)
                }

            }



        }

        socket.onclose = function (e) {
            console.log('Disconnected')
        }

        function sendMessage() {

            var text_message = document.getElementById('message').value

            if (text_message.value == '') {
                alert('message cant be null')
                return;
            }

            socket.send(JSON.stringify({
                'text_message': text_message,
                'sender': 'teacher'
            }))

            document.getElementById('message').value = ''

        }

        var flag = true

        function addMessageToUi(data) {

            var chat_ui = document.getElementById('chat_ui')

            var text_message = data.text_message
            var sender = data.sender


            if (flag) {
                chat_ui.innerHTML += `<div class="media w-100 mb-3">
                    <div class="media-body ml-3">
                        <div class="bg-light rounded py-2 px-3 mb-2">
                            <p class="text-small mb-0 text-muted">
                                ${text_message}</p>
                        </div>
                        <p>Sender - ${sender} </p>
                    </div>
                </div>`

                flag = !flag
            } else {
                chat_ui.innerHTML += `<div class="media w-100 mb-3">
                    <div class="media-body ml-3">
                        <div class="bg-primary rounded py-2 px-3 mb-2">
                            <p class="text-small mb-0 text-white">
                                ${text_message}</p>
                        </div>
                        <p>Sender - ${sender} </p>
                    </div>
                </div>`

                flag = !flag
            }


        }




        function add_online(data) {
            console.log("called")
            var element = document.getElementById('people_online')
            console.log(data)
            var online_users = data.online_users

            var html = ''
            for (var i = 0; i < online_users.length; i++) {
                var user = online_users[i].user
                var user_id = online_users[i].user_id
                html += `<div class="col-md-2" id="user_online_id_${user_id}">
            <img src="https://i.pinimg.com/originals/51/f6/fb/51f6fb256629fc755b8870c801092942.png" alt="user" width="50" class="rounded-circle">
            <p>${user}</p>
            </div>`
            }



            element.innerHTML = html

        }

        function remove_online(user_id) {
            var element = document.getElementById(`user_online_id_${user_id}`)
            element.remove();
        }
    </script> -->

    {% endblock %}