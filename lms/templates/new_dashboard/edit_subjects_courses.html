{%extends 'base.html'%}
{% block start %}

<style>
    @import url('https://fonts.googleapis.com/css?family=Lato&display=swap');

    :root {
    --border-color: #e3e5e4;
    --background-color: #c3c7ca;
    --text-color: #34444f;
    }

    .draggable-list {
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 0;
        list-style-type: none;
        margin: 1%;
    }

    .draggable-list li {
    background-color: #fff;
    display: flex;
    flex: 1;
    }

    .draggable-list li:not(:last-of-type) {
    border-bottom: 1px solid var(--border-color);
    }

    .draggable-list .number {
    background-color: var(--background-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    height: 60px;
    width: 60px;
    }

    .draggable-list li.over .draggable {
    background-color: #eaeaea;
    }

    .draggable-list .person-name {
    margin: 0 20px 0 0;
    }

    .draggable-list li.right .person-name {
    color: #3ae374;
    }

    .draggable-list li.wrong .person-name {
    color: #ff3838;
    }

    .draggable {
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px;
    flex: 1;
    }

    .draggable2 {
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px;
    flex: 1;
    }

    .draggable3 {
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px;
    flex: 1;
    }

    .check-btn {
    background-color: var(--background-color);
    border: none;
    color: var(--text-color);
    font-size: 16px;
    padding: 10px 20px;
    cursor: pointer;
    margin: 1%;
    }

    .check-btn:active {
    transform: scale(0.98);
    }

    .check-btn:focus {
    outline: none;
    }
</style>

<script
    src="https://kit.fontawesome.com/3da1a747b2.js"
    crossorigin="anonymous"
></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>

{% include "utils/alert.html" %}

<ul class="nav nav-pills nav-fill" style="margin-top: 8%;">
    <li class="nav-item">
        <a class="nav-link active" aria-current="page" id="contentBtn" href="#">Package Details</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="treeBtn" href="#">View Tree</a>
    </li>
    </ul>

    <hr>

<div class="collapse show" style="margin: 2%;" id="contentDiv">
  <div class="card-body">

    {% include "utils/alert.html" %}
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-row mb-4">
            <div class="form-group col-md-6">
                <label for="lesson_title">Package Name</label>
                <input type="text" value="{{course_package_obj.package_title}}" class="form-control" required name="lesson_title" id="inputEmail4"
                    placeholder="Enter lesson title">
            </div>
            <div class="form-group col-md-6">
                <label for="package_type"> Package Type</label>
                <select required id="subjects" name="package_type" class="form-control basic tagging ">
                    <option value="video">Video</option>
                    <option value="text">Text</option>
                </select>
            </div>
            <div class="form-group col-md-6">

                <label for="actual_price">Actual Price</label>
                <input type="number" value="course_package_obj.actual_price name="actual_price" class="form-control" placeholder="Enter Actual Price in Rupees"> 
                
            </div>

            <div class="form-group col-md-6">
                <label for="selling_price">Selling Price</label>
                <input type="number" name="selling_price" value="course_package_obj.selling_price" class="form-control" placeholder="Enter Selling Price in Rupees"> 
            </div>


        </div>
        <div class="form-row mb-4" id="video_upload">

            <div class="form-group col-md-6">
                <div id="expiryTypePicker">
                    <label for="expiryType"> Enter Start Time Of Live </label>
                    <select name="expiryType" class="form-control" onchange="changeExpiryType(event)">
                        <option selected>Choose Expiry Type</option>
                        <option value="fixed-date">Fixed Date</option>
                        <option value="subscription">Subscription</option>
                    </select>
                </div>


                <div id="expiryDateContainer" style="display: none; margin-top: 3%;">
                    <label for="expiryDate">Choose Expiry Date</label>
                    <input type="date" name="expiryDate" class="form-control" id="expiryDate">
                </div>

                <div id="subscriptionContainer" style="display: none; margin-top: 3%;">
                    <label for="subscriptionDays">Subscription Period</label>
                    <input type="number" class="form-control" placeholder="Enter Subscription Period (in Days)">
                </div>

            </div>

           

           
        </div>
        

        <div class="form-row mb-4">
            <div class="form-group col-md-12">
                <label for="description">Description </label>
                <textarea id="summernote" name="description" class="form-control" cols="30" rows="5"></textarea>
            </div>
        </div>

        <div class="form-row mb-4" id="document_upload">

            <div class="form-group mb-6">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" name="image_for_web" id="inputGroupFile01">
                    <label class="custom-file-label" for="image_for_web">Choose file For Web</label>
                </div>
            </div>

            <div class="form-group mb-6">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" name="image_for_app" id="inputGroupFile01">
                    <label class="custom-file-label" for="image_for_app">Choose file For App</label>
                </div>
            </div>

        </div>

        <button type="submit" class="btn btn-primary mt-3">Create Package</button>
    </form>

</div>

</div>

<div class="collapse show" id="treeDiv" style="display: none;">
    <div class="container-fluid">
        <div class="row">

            <div class="col-md-6">
                <h3>You Are Re-odering All Subjects </h3>
    

                <div class="collapse show m-2" id="reorderChapterDiv">
                    <label for="selectedSubject">Select Subject whose chapters you want to reorder </label>
                    <select name="selectedSubject" id="selectedSubject" class="form-control" onchange="reorderChapters(event)">
                        <option value="0" selected disabled>Choose Subject</option>
                        
                    </select>

                    <div id="selectChapterDiv" style="display: none;">
                        <label for="selectedChapter">Select chapter whose lessons you want to reorder </label>
                        <select name="selectedChapter" id="selectedChapter" class="form-control" onchange="reorderChapters(event)">
                            <option value="0" selected disabled>Choose Chapter</option>
                            
                        </select>
                    </div>

                    <button class="check-btn" id="chooseChapterBtn">
                            Choose Chapter 
                    </button>

                    <button class="check-btn" id="reorderBtn">
                        Reorder 
                    </button>

                </div>
                

            </div>


            <div class="col-md-6">
                <h3 id="titleData">Subject</h3>
                <ul class="draggable-list" id="draggable-list" style="height: 610px; overflow-y: scroll;"></ul>
                <button class="check-btn" id="saveBtn">
                    Save 
                <i class="fas fa-save"></i>
                </button>
            </div>

        </div>

    </div>
</div>



<script>
    // script for nav btn start
    let flag = true;
    let contentBtn = document.getElementById('contentBtn');
    let treeBtn = document.getElementById('treeBtn');
    let contentDiv = document.getElementById('contentDiv');
    let treeDiv = document.getElementById('treeDiv');
    let tagSection = document.getElementById('tagSection');
    let tagsDropdown = document.getElementById('tagsDropdown');

    contentBtn.addEventListener('click', function () {
        contentBtn.classList.add('active');
        treeBtn.classList.remove('active');
        contentDiv.style.display = 'block';
        treeDiv.style.display = 'none';
    });

    treeBtn.addEventListener('click', function () {
        contentBtn.classList.remove('active');
        treeBtn.classList.add('active');
        contentDiv.style.display = 'none';
        treeDiv.style.display = 'block';
        if (flag === true) {
            draggableTree();
            flag = false;    
        }
        
    });

    // script for nav btn ends


    // script for tree options start

    let reorderChapterBtn = document.getElementById('reorderChapterBtn');
    let reorderLessonsBtn = document.getElementById('reorderLessonsBtn');
    let reorderChapterDiv = document.getElementById('reorderChapterDiv');
    let reorderLessonsDiv = document.getElementById('reorderLessonsDiv');

    // reorderChapterBtn.addEventListener('click', function () {
    //     reorderChapterDiv.style.display = 'block';
    //     reorderLessonsDiv.style.display = 'none';
    //     reorderChapterBtn.classList.add('active');
    //     reorderLessonsBtn.classList.remove('active');
    // });

    // reorderLessonsBtn.addEventListener('click', function () {
    //     reorderChapterDiv.style.display = 'none';
    //     reorderLessonsDiv.style.display = 'block';
    //     reorderChapterBtn.classList.remove('active');
    //     reorderLessonsBtn.classList.add('active');
    // });

    // script for tree ends

    // script to add reorder chapters

    let selectedSubject = document.getElementById('selectedSubject');
    let selectedChapter = document.getElementById('selectedChapter');
    let selectChapterDiv = document.getElementById('selectChapterDiv');
    let chooseChapterBtn = document.getElementById('chooseChapterBtn');
    let reorderBtn = document.getElementById('reorderBtn');
    let allSubjects; // all subjects array
    let subjectUid;
    let chapterUid;
    let subjectssArray = [];
    let chaptersArray = [];
    let lessonsArray = [];


    function reorderChapters(event) {
        console.log(event.target.value);
    };



    // script for draggable tree starts
    function draggableTree() {  
        let saveBtn = document.getElementById('saveBtn');


        const draggable_list = document.getElementById('draggable-list');

        let uid = '{{course_package_obj.uid}}'
        console.log(uid);
        
        fetch('/api/courses/course-package-info/?uid='+ uid, {
        method: 'GET',
        })
        .then(response => response.json())
        .then(data => {
            
            allSubjects = data.data;
            let subjectsArray = [];
            allSubjects.subjects.forEach(e => {
                console.log(e);
                subjectsArray.push(e.subject_title);
                // adding all subjects to options in dropdown
                let opt = document.createElement('option');
                opt.innerHTML = e.subject_title;
                opt.value = e.subject_uid;
                selectedSubject.appendChild(opt);

            })
            createList(subjectsArray);

            selectedSubject.addEventListener('change', function () {
                console.log('onchange');
                subjectUid = selectedSubject.value;
                let allChapters;
                allSubjects.subjects.forEach((e, i) => {
                    if (e.subject_uid === subjectUid) {
                        console.log(e.chapters);
                        allChapters = e.chapters;
                        allChapters.forEach(e => {
                            chaptersArray.push(e.chapter_title);
                            // adding all chapters to options in dropdown
                            let opt = document.createElement('option');
                            opt.innerHTML = e.chapter_title;
                            opt.value = e.chapter_uid;
                            selectedChapter.appendChild(opt);

                        })
                    }
                })

           
            }) ///

            selectedChapter.addEventListener('change', function () {
                chapterUid = selectedChapter.value;
                // updating lessons array
                allSubjects.subjects.forEach(e => {
                    if (e.subject_uid === subjectUid) {
                        e.chapters.forEach(e => {
                            if (e.chapter_uid === chapterUid) {
                                e.lessons.forEach(e => {
                                    lessonsArray.push(e.lesson_title);
                                    console.log(lessonsArray);
                                })
                            }
                        })
                    }
                })
            });

            chooseChapterBtn.addEventListener('click', function () {
                selectChapterDiv.style.display = 'block';
                chooseChapterBtn.style.display = 'none';
            });

            reorderBtn.addEventListener('click', function () {
                if (selectedSubject.value === "0") {
                    alert('Please select a subject');
                    return;
                } else if (selectedSubject.value !== "0") {
                    // code to send list of chapters to reorder
                    console.log('send chapters array');

                } else if (selectedChapter.value === "0" && selectedSubject.value !== "0") {
                    let selectedSubjectUID = selectedSubject.value;
                    // code to send list of lessons to reorder
                    console.log('send lesson array');

                }


                chooseChapterBtn.style.display = 'none';


            });
        });

        

       
        const listItems = [];

        let dragStartIndex;       

        // Insert list items into DOM

        function createList(array) {
            array.forEach((person, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'subject-li';

                listItem.onclick = (event) => {
                    console.log('wwooeee');
                    
                }

                listItem.setAttribute('data-index', index);

                listItem.innerHTML = `
                    <span class="number">${index + 1}</span>
                    <div class="draggable" draggable="true">
                    <p class="person-name">${person}</p>
                    <i class="fas fa-arrow-right"></i>
                    </div>
                `;

                listItems.push(listItem);

                draggable_list.appendChild(listItem);
                });

            addEventListeners();
        }


        function dragStart() {
            // console.log('Event: ', 'dragstart', );
            dragStartIndex = +this.closest('li').getAttribute('data-index');
        }

        function dragEnter() {
            // console.log('Event: ', 'dragenter', this.closest('li'));
            this.classList.add('over');
        }

        function dragLeave() {
            // console.log('Event: ', 'dragleave');
            this.classList.remove('over');
        }

        function dragOver(e) {
            // console.log('Event: ', 'dragover');
            e.preventDefault();
        }

        function dragDrop() {
            console.log('Event: ', 'drop');
            const dragEndIndex = +this.getAttribute('data-index');
            swapItems(dragStartIndex, dragEndIndex);
            saveSubject.style.backgroundColor = '#9fff83';
            subjectsChanged = true;

            this.classList.remove('over');
        }

        // Swap list items that are drag and drop
        function swapItems(fromIndex, toIndex) {
            const itemOne = listItems[fromIndex].querySelector('.draggable');
            const itemTwo = listItems[toIndex].querySelector('.draggable');

            console.log(itemOne, itemTwo);

            listItems[fromIndex].appendChild(itemTwo);
            listItems[toIndex].appendChild(itemOne);
        }

        function addEventListeners() {
            const draggables = document.querySelectorAll('.draggable');
            const dragListItems = document.querySelectorAll('#draggable-list li');

            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', dragStart);
            });

            dragListItems.forEach(item => {
                item.addEventListener('dragover', dragOver);
                item.addEventListener('drop', dragDrop);
                item.addEventListener('dragenter', dragEnter);
                item.addEventListener('dragleave', dragLeave);
            });
        }

    }
    // scripts for draggable tree ends


let one = document.querySelector('#container1')
let two = document.querySelector('#container2')
var course_package_uid = '{{course_package_uid}}'
var CSRF_TOKEN = '{{csrf_token}}'


function addLessonToChapter(subject_uid, chapter_uid, lesson_uid) {
    var payload = {
        'subject_uid': subject_uid,
        'chapter_uid': chapter_uid,
        'lesson_uid': lesson_uid,
        'course_package_uid': course_package_uid
    }

    const headers = {
        'X-CSRFToken': CSRF_TOKEN
    }

    axios.post('/api/courses/save-course-package/', payload, {
            headers: headers
        })
        .then(function (response) {
            console.log(response);
        })
        .catch(function (error) {
            console.log(error);
        });




}

function getUid() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('uid');
}

function getSubjectUid(){
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('subject_uid');
}

function getChapters(v = 1) {
    
    var subject_uid =  document.getElementById('subject').value
    window.location.href = `?subject_uid=${subject_uid}`
    
    return
    if (v == 0) {
        clearTable()
    }
    var subject = document.getElementById('subject').value
    axios.get(`/api/courses/get-chapters/?uid=${subject}`)
        .then(response => {
            console.log(response)

            var chapters = response.data.data
            $("#chapter").empty();
            var opt = document.createElement('option');

            opt.innerHTML = 'Choose';
            document.getElementById('chapter').appendChild(opt);
            console.log(chapters.length)
            for (var i = 0; i < chapters.length; i++) {
                var opt = document.createElement('option');
                console.warn(chapters[i].uid)
                opt.value = chapters[i].uid;
                opt.innerHTML = chapters[i].chapter_title;

                if (chapters[i].uid == getUid()) {
                    opt.setAttribute('selected', true);
                }

                document.getElementById('chapter').appendChild(opt);
                console.log('append')
            }
        })
}

function getLessons() {
    var chapter = document.getElementById('chapter').value
    window.location.href = `?uid=${chapter}&subject_uid=${getSubjectUid()}`
    return;
}

function clearTable() {
    document.getElementById('table').innerHTML = ''
}





function getSelectedValues() {
    var selectedVal = $("#multiselect").val();
    for (var i = 0; i < selectedVal.length; i++) {
        function innerFunc(i) {
            setTimeout(function () {
                location.href = selectedVal[i];
            }, i * 2000);
        }
        innerFunc(i);
    }
}
</script>


{% endblock %}