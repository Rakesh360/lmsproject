{%extends 'base.html'%}
{% block start %}

<style type="text/css">
    .bg-1 {
        background: #ECECF8;
    }

    .deleteBtn{
        cursor: pointer;
    }
</style>

<div class="section-header" style="margin-top: 5%;">
    <h1>Edit Lesson</h1>

</div>


    <div class="card" id="contentDiv" style="display: block;">  
        <!-- <div class="card-header">
        <h4>Horizontal Form</h4>
    </div> -->
        <div class="card-body">
            {% include "utils/alert.html" %}
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-row mb-4">
                    <div class="form-group col-md-6">
                        <label for="inputEmail4">Lesson title</label>
                        <input type="text" class="form-control" required name="lesson_title" value="{{lesson.lesson_title}}"
                            id="lesson_title" placeholder="Enter lesson title">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="inputPassword4">Subject Chapters</label>
                        <select required id="chooseChapters" name="chapters" class="form-control basic tagging ">
                            {% for subject_chapter in  subject_chapters %}
                            <option {% if lesson.subject_chapters ==  subject_chapter %} selected {% endif %}
                                value="{{subject_chapter.uid}}">{{subject_chapter.chapter_title}}</option>
                            {% endfor  %}
                        </select>
                    </div>

                    <div class="form-group col-md-6">

                        <label for="inputEmail4">Is free</label>
                        <select class="form-control" name="is_free">
                            <option value="0">No</option>
                            <option value="1">Yes</option>

                        </select>
                    </div>

                    <div class="form-group col-md-6">
                        
                        <label for="lesson_type">Lesson Type</label>
                        <select class="form-control" id="lesson_type" name="lesson_type" onchange="changeLessonType()">
                            <option  {% if lesson.lesson_type == 'Video' %} selected {% endif %} value="Video">Video</option>
                            <option  {% if lesson.lesson_type == 'Document' %} selected {% endif %} value="Document">Document</option>
                            <option  {% if lesson.lesson_type == 'Video + Document' %} selected {% endif %} value="Video + Document">Video + Document</option>


                        </select>
                    </div>

                

    </div>

                    <div class="form-row mb-4" id="video_upload">

                        <div class="form-group col-md-6">
                            <label for="video_uploaded_on">Video Platform</label>
                            <select id="videoType" required class="form-control" name="video_uploaded_on">
                                <option {% if lesson.video_uploaded_on == 'Vimeo' %} selected {% endif %} value="Vimeo">Vimeo
                                </option>
                                <option {% if lesson.video_uploaded_on == 'Youtube' %} selected {% endif %} value="Youtube">
                                    Youtube</option>
        
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="video_link">Lesson Link</label>
                            <input value="{{lesson.video.video_link}}" type="text" onchange="loadLesson()" required id="lesson_link" class="form-control"
                                name="video_link" id="video_link" placeholder="Enter lesson title">
                            <small>Paste Id only</small>
                            <iframe width="550" id="iframe" height="215" src="">
                            </iframe>
                        </div>
                    </div>

                    <div class="form-row mb-4" id="document_upload" style="display: none;">

                        <div class="form-group col-md-6">
                            <label>Upload Document</label>  <a href="/{{lesson.document}}"></a>
                            <input class="form-control" id="document_link" type="file" name="document">
                        </div>

                    </div>



                </div>
            </form>

    </div>

    <div class="card" id="publishDiv" style="display: block;">
        <!-- <div class="card-header">
        <h4>Horizontal Form</h4>    
      </div> -->
        <div class="card-body">
            {% include "utils/alert.html" %}
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-row mb-4">
                  
                    <div class="form-group col-md-6">
    
                        <label for="inputEmail4">Is free</label>
                        <select class="form-control" id="is_free" name="is_free">
                            <option value="0">No</option>
                            <option value="1">Yes</option>
    
                        </select>
                    </div>
                </div>
    
    
                <div class="form-row mb-4" id="video_upload">
                    <!-- tags selection part -->
    
    
                    
                    <div>
                        <label for="tags">Select Packages To Include</label>
                        <select required id="tagsDropdown" name="tags" class="fstdropdown-select" onchange="includeTag(event)">
                            <option value="" selected>Choose Package</option>
                            {% for subject_chapter in  subject_chapters %}
                            <option value="{{subject_chapter.uid}}">{{subject_chapter.chapter_title}}</option>
                            {% endfor  %}
                        </select>  
                    </div> 
    
                    <br>
                    <p>{{lesson.packages}}</p>
                    <div class="table table-striped" style="margin: 1%;">
                        <table class="display">
                            <!-- <thead>
                                <tr><td>Package Name</td></tr>
                                <tr><td>Published Date</td></tr>
                                <tr><td>Action</td></tr>
                            </thead> -->
                            <tbody id="tags">
                                <!-- use for loop to show already selected pacages... -->
                                <!-- <tr><td class="tag">Tag1</td> <td><input type="datetime-local"></td> <td class="delBtn" onclick="deleteTag(event)">❌</td></tr>
                                <tr><td class="tag">Tag2</td> <td><input type="datetime-local"></td> <td class="delBtn" onclick="deleteTag(event)">❌</td></tr>
                                <tr><td class="tag">Tag3</td> <td><input type="datetime-local"></td> <td class="delBtn" onclick="deleteTag(event)">❌</td></tr> -->
                            </tbody>
                        </table>  
                    </div>               
                </div>
    
    
                
    
               <button type="submit" id="updateBtn" class="btn btn-primary mt-3">Update Published Details</button>
            </form>
    
        </div>
    </div>

<script>
    // function to parse date from 1632058848038 to 2018-12-31T00:00:00.000Z
    function parseDate(date) {
        var date = new Date(date);
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var day = date.getDate();
        var hour = date.getHours();
        var min = date.getMinutes();
        var sec = date.getSeconds();
        var dateString = year + "-" + month + "-" + day + "T" + hour + ":" + min + ":" + sec + "Z";
        return dateString;
        
    }


    let iframe = document.getElementById('iframe');
    let lesson_link = document.getElementById('lesson_link');
    lesson_link.onchange = loadLesson;
    if (lesson_link.value !== '') {
        loadLesson();
    }

    let tagSection = document.getElementById('tagSection');
    let tagsDropdown = document.getElementById('tagsDropdown');

    


    function deleteTag(event) {
        event.currentTarget.parentNode.remove();
    };

    
    function checkTag(tagName) {
        let allTags = document.getElementsByClassName('tag');
        let flag = false;
        for (let i = 0; i < allTags.length; i++) {
            let singleTag = allTags[i];
            if (singleTag.innerHTML === tagName) {
                flag = true;
                break;
            }
            
        }

        return flag;
    }

    function clickTag(event) {
        let tagName = event.target.innerHTML;
        let tagId = event.target.id;
        console.log(tagName, tagId);
    }


    let tags = document.getElementById('tags');
    function includeTag(event, id) {
        let tagName = event.currentTarget.selectedOptions[0].innerText;
        let tagId = event.currentTarget.value;
        if (event.currentTarget.value === "") {
            console.log('nothing selected');
        } else {
           if (checkTag(tagName) === true ) {
               console.log('Tag already exists...');
           } else {
                let tagElement = document.createElement('tr');
                // tagElement.className = "badge badge-dark p-1 m-1 tag";
                let td1 = document.createElement('td');
                td1.className = "tag";
                td1.innerHTML = tagName;
                td1.id = tagId;
                let td2 = document.createElement('td');
                td2.innerHTML = '<input class="packageDate" type="datetime-local" name='+id+'>';
                let td3 = document.createElement('td');
                td3.innerHTML = '❌';
                td3.className = 'delBtn';
                td3.addEventListener("click", deleteTag);
                tagElement.appendChild(td1);
                tagElement.appendChild(td2);
                tagElement.appendChild(td3);
                tags.appendChild(tagElement);
           }
        }
    }

    function changeVideoType() {
        let videoType = document.getElementById('videoType');
        if (videoType.value == 'Live') {
            document.getElementById('timePicker').style.display = 'block';
        } else {
            document.getElementById('timePicker').style.display = 'none';
        }
    };


    function changeLessonType() {
        var element = document.getElementById('element')
        console.log(element.value)
        if (element.value == 'Video') {
            document.getElementById('video_upload').style.display = ''
            document.getElementById('document_upload').style.display = 'none'
            document.getElementById('document').required = false
            document.getElementById('lesson_link').required = true

        } else if(element.value == 'Document') {
            document.getElementById('document_upload').style.display = ''
            document.getElementById('video_upload').style.display = 'none'
            document.getElementById('document').required = true
            document.getElementById('lesson_link').required = false
        }else if(element.value == 'Video + Document'){
            document.getElementById('document_upload').style.display = ''
            document.getElementById('video_upload').style.display = ''
            document.getElementById('document').required = true
            document.getElementById('lesson_link').required = true
        }
    }

    function loadLesson() {
        var element = document.getElementById('lesson_link').value

        if (element) {
            var url = `https://www.youtube.com/embed/${element}`
            document.getElementById('iframe').style.display = ''
            document.getElementById('iframe').src = url
        }else{
            document.getElementById('iframe').style.display = 'none'
            document.getElementById('iframe').src = ''
        }


    }

    function getCookie(name) {
        if (!document.cookie) {
            return null;
        }
        const xsrfCookies = document.cookie.split(';')
        .map(c => c.trim())
        .filter(c => c.startsWith(name + '='));
        if (xsrfCookies.length === 0) {
            return null;
        }
            return decodeURIComponent(xsrfCookies[0].split('=')[1]);
    }
    
    const csrfToken = getCookie('csrftoken');

    let docReUploaded = false;
    document.getElementById('document_link').onchange = function() {
        docReUploaded = true;
        console.log('doc uploaded changed');
    }

    async function uploadoc() {
        console.log('Uploading file...');
        // document.getElementById('loader').style.display = 'block';
        const formData = new FormData();
        formData.append('document_file', document.getElementById('document_link').files[0]);
        let response = await fetch('/api/courses/document/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        const json = await response.json();
        console.log(json);
        return json.uid;

        

    }

    
    const submitForm = async (e) => {
        e.preventDefault();

        
        let video_platform = document.getElementById('videoType').value;
        let data = {
            'uid': '{{lesson.uid}}',
            'lesson_title' : document.getElementById('lesson_title').value,
            'chapter' : document.getElementById('chooseChapters').value,
            'video_platform' : video_platform,
            'lesson_type' : document.getElementById('lesson_type').value,
            'is_free' : document.getElementById('is_free').value,
            'video': {
                'video_link': document.getElementById('lesson_link').value,
            }
        };

        // document upload
        if (docReUploaded === true) {
            let docLink = await uploadoc();
            console.log('...', docLink);
            data['document'] = docLink;
        }
        
    
        // getting data of all packages...
        let allTags = document.getElementsByClassName('tag');
        let allPackageDates = document.getElementsByClassName('packageDate');
        let packages = [];
        for (let i = 0; i < allTags.length; i++) {
            if (allPackageDates[i].value === '') {
                packages.push({
                    "uid" : allTags[i].id,
                    "created_at" : parseDate(Date.now()),
                });
            } else {
                packages.push({
                    "uid" : allTags[i].id,
                    "created_at" : allPackageDates[i].value
                });
            }
            
            
        };
        data['packages'] = packages;

        console.log(data);

        if (video_platform === 'Live') {
            fetch('/api/courses/go-live/', {
                method: 'POST', // or 'PUT'
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                })
                .catch((error) => {
                    console.error('Error:', error);
            });
        } else {
            fetch('/api/courses/lessons/', {
                method: 'POST', // or 'PUT'
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                })
                .catch((error) => {
                    console.error('Error:', error);
            });
        }

        // log all data of form data
    };

    const updateBtn = document.getElementById('updateBtn');
    updateBtn.addEventListener('click', submitForm)


</script>



{% endblock %}