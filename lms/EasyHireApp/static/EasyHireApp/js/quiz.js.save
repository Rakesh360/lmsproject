var is_quiz_started = null;
var problemCounter = 0;
var totalProblems = 0;
var last_attempted_quiz_section_id = null;
var speech_synthesis_utterance_instance = null;
var speech_synthesis_instance = window.speechSynthesis;
var voices = null;


//////////////// New Function added related to enabling Web Sockets /////////////
var socket = null;

function EnableWebSocket(){
    var unique_quiz_config_id = window.location.pathname.split("/")[3];
    var url = `wss://easyhire-uat.allincall.in:8001/ws/sync/time/${unique_quiz_config_id}/${request_user.value}`
    socket = new WebSocket(url);
    socket.onopen = function (e) {console.log("Connected")}
    socket.onmessage = function (e) {console.log(e)};
    socket.onclose = function (e) {
    console.log('Socket closed')
    sync_remaining_time()
    }
}
///////////////////////// End /////////////////

window.onload = function(){
    document.addEventListener("visibilitychange", function()
    {
        if(document.hidden)
        {
            console.log("Tab change detected")
            window.location = "/applicant/dashboard/"
        }
    }, false);
}

function getCsrfToken() {
    var CSRF_TOKEN = $('input[name="csrfmiddlewaretoken"]').val();
    return CSRF_TOKEN;
}

function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m, key, value) {
        vars[key] = value;
    });
    return vars;
}

function disableF5(e) {
    if ((e.which || e.keyCode) == 116) e.preventDefault();
}

function preventCopyPasteWithID(element_id) {
    if ($("#" + element_id).length == 1) {
        console.log("element found");
        $(document).bind("cut copy paste", '#' + element_id, function(e) {
            console.log("cut copy paste is not allowed");
            e.preventDefault();
        });
    }
}

$(window).keyup(function(e){
      console.log(e.keyCode);
      if(e.keyCode == 27){
          e.preventDefault();
      }
});

function textToSpeech(message_to_be_spoken) {
    if (speech_synthesis_instance != null) {
        speech_synthesis_instance.cancel();
    }
    speech_synthesis_utterance_instance = new SpeechSynthesisUtterance(message_to_be_spoken);
    speech_synthesis_utterance_instance.lang = "hi";
    speech_synthesis_utterance_instance.rate = 0.95;
    speech_synthesis_utterance_instance.pitch = 1;
    speech_synthesis_utterance_instance.volume = 1;
    voices = speech_synthesis_instance.getVoices();
    speech_synthesis_instance.speak(speech_synthesis_utterance_instance);
}

function speakTheProblem() {
    problem = document.getElementById("problem-description").innerText;
    textToSpeech(problem);
}

function startGlobalVideoCapture() {
    $("#btn-start-recording").click();
    //startScreenShotTimer();
}

function stopGlobalVideoCapture() {
    $("#btn-stop-recording").click();
    //clearScreenShotTimer();
}

function takeScreenShot() {
    console.log("Image captured")
    $("#btn-take-screenshot").click();
}

var screen_shot_min_counter_timeout = null;
/*
function startScreenShotTimer() {
    screen_shot_min_counter_timeout = setInterval(takeScreenShot, 20000);
}

function clearScreenShotTimer() {
    if (screen_shot_min_counter_timeout != null) {
        clearInterval(screen_shot_min_counter_timeout);
    }
}*/

var sync_time_min_counter_timeout = null;

function startSyncTimeTimer(){
    sync_time_min_counter_timeout = setInterval(sync_remaining_time, 5000);
}

//$(document).on("click", "#btn-take-screenshot", function(e) {
//    quiz_uuid = window.location.pathname.split("/")[3];
//    video = document.getElementById('global-video-captured-response');
//    canvas = document.getElementById('global-canvas-video-capture');
//    img = document.getElementById('captured-image-from-video');
//
//    canvas.width = 200;
//    canvas.height = 150;
//    canvas.getContext('2d').drawImage(video, 0, 0, 200, 150);
//    img.src = canvas.toDataURL('image/png');
//    CSRF_TOKEN = getCsrfToken();
//    $.ajax({
//        url: "/applicant/save-screenshots/",
//        type: "POST",
//        headers: {
//            "X-CSRFToken": CSRF_TOKEN
//        },
//        data: {
//            applicant_image: img.src,
//            quiz_uuid:quiz_uuid
//        },
//        success: function(response) {
//            if (response["status_code"]==200){
//                /*if(response["is_multiple_faces"]){
//                    $("#modal-multiple-faces-detected").modal({
//                        onCloseEnd: function() {
//                            clearTimeout(completed_quiz_timeout);
//                            window.location = "/applicant/dashboard";
//                        }
//                    });
//                    $("#modal-multiple-faces-detected").modal('open');
//
//                    completed_quiz_timeout = setTimeout(function(e) {
//                        $("#modal-multiple-faces-detected").modal('close');
//                    }, 10000);
//                }*/
//                console.log("success")
//            }
//        },
//        error: function(xhr, textstatus, errorthrown) {
//            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
//        }
//    });
//});

$(document).on("click", "#btn-take-screenshot", function(e) {

    navigator.getMedia = (navigator.getUserMedia || // use the proper vendor prefix
    navigator.webkitGetUserMedia ||
    navigator.mozGetUserMedia ||
    navigator.msGetUserMedia);

    navigator.getMedia({
        video: true,
    }, function () {
        console.log("Webcam is on...");
        quiz_uuid = window.location.pathname.split("/")[3];
        video = document.getElementById('global-video-captured-response');
        canvas = document.getElementById('global-canvas-video-capture');
        img = document.getElementById('captured-image-from-video');

        canvas.width = 200;
        canvas.height = 150;
        canvas.getContext('2d').drawImage(video, 0, 0, 200, 150);
        img.src = canvas.toDataURL('image/png');
        CSRF_TOKEN = getCsrfToken();
        $.ajax({
            url: "/applicant/save-screenshots/",
            type: "POST",
            headers: {
                "X-CSRFToken": CSRF_TOKEN
            },
            data: {
                applicant_image: img.src,
                quiz_uuid:quiz_uuid
            },
            success: function(response) {
                if (response["status_code"]==200){
                    console.log("success")
                }
            },
            error: function(xhr, textstatus, errorthrown) {
                console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
            }
        });
    }, function () {
        alert("Please allow webcam and microphone access, post that kindly restart the quiz.");
		window.location = "/applicant/dashboard/";
    });

});

var last_uploaded_video_url = "";

function saveVideoAtServer(data_url, problem_id) {
    CSRF_TOKEN = getCsrfToken();
    $.ajax({
        url: "/applicant/save-video/",
        type: "POST",
        async: false,
        headers: {
            "X-CSRFToken": CSRF_TOKEN
        },
        data: {
            "video_data_url": data_url,
            "quiz_uuid":quiz_uuid,
             "problem_id":problem_id,
        },
        success: function(response) {
            last_uploaded_video_url = response["url"];
        },
        error: function(xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
}

var recorded_video_data_url = null;
var flag_video_url_saved = false;
var flag_video_recording_started = false;
function initializeCaptureVideo(video_element_id, video_captured_canvas, start_button_id, stop_button_id, preview_button_id, is_save = false, is_audio_required = false, is_speech_to_text_required = false) {
    // Store a reference of the preview video element and a global reference to the recorder instance
    video = document.getElementById(video_element_id);
    canvas = document.getElementById(video_captured_canvas);
    // When the user clicks on start video recording
    document.getElementById(start_button_id).addEventListener("click", function() {
        // Disable start recording button
        this.disabled = true;
        // Request access to the media devices
        navigator.mediaDevices.getUserMedia({
            audio: is_audio_required,
            video: true
        }).then(function(stream) {
            // Display a live preview on the video element of the page
            setSrcObject(stream, video);

            // Start to display the preview on the video element
            // and mute the video to disable the echo issue !
            video.play();
            video.muted = true;

            // Initialize the recorder
            recorder = new RecordRTCPromisesHandler(stream, {
                mimeType: 'video/webm',
                bitsPerSecond: 128000
            });

            // Start recording the video
            recorder.startRecording().then(function() {
                // console.info('Recording video ...');
            }).catch(function(error) {
                console.error('Cannot start video recording: ', error);
            });

            // release stream on stopRecording
            recorder.stream = stream;
            videoStarted = true;

            if (is_speech_to_text_required == true) {
                startSpeechToText(this);
            }

            // screenShotTimer();
            // Enable stop recording button
            document.getElementById(stop_button_id).disabled = false;
            document.getElementById(preview_button_id).disabled = true;
            if(start_button_id=="btn-start-video-recording") {
                 document.getElementById("btn-next-question").disabled = true;
		 flag_video_recording_started = true;
	   }
        }).catch(function(error) {
            alert("Please allow webcam and microphone access, post that kindly restart the quiz.");
            console.error("Cannot access media devices: ", error);
        });
    }, false);

    // When the user clicks on Stop video recording
    document.getElementById(stop_button_id).addEventListener("click", function() {
        var dfd = $.Deferred();
        this.disabled = true;
        recorder.stopRecording().then(function() {
            // console.info('stopRecording success');

            // Retrieve recorded video as blob and display in the preview element
            videoBlob = recorder.blob;
            // console.log("DataURL:", recorder.getDataURL());
            recorder.getDataURL().then(function(result) {
                recorded_video_data_url = result;
            });

            // video.src = URL.createObjectURL(videoBlob);
            // video.play();

            // Unmute video on preview
            // video.muted = false;

            if (is_speech_to_text_required == true) {
                stopSpeechToText(this);
            }

            // Stop the device streaming
            recorder.stream.stop();
            videoStopped = true;
            // stopSpeechToText(this);
            // clearTimeout(one_min_counter_timeout);
            // Enable record button again !
            //document.getElementById("btn-preview-video-recording").disabled = true;
            document.getElementById(start_button_id).disabled = false;
            document.getElementById(preview_button_id).disabled = false;
            if(stop_button_id=="btn-stop-video-recording")
                 document.getElementById("btn-next-question").disabled = false;   
             flag_video_url_saved = true;
        }).catch(function(error) {
            console.error('stopRecording failure', error);
        });
    }, false);

    document.getElementById(preview_button_id).addEventListener("click", function() {
        this.disabled = true;
        // recorder.previewRecording().then(function() 
        // {
            // Retrieve recorded video as blob and display in the preview element
        // videoBlob = recorder.blob;
        // recorder.getDataURL().then(function(result) {
        //     recorded_video_data_url = result;
        // });
        // video.src = recorded_video_data_url;
        // video.play();
        var new_window = window.open("");
        inner_video_html = "<video controls><source type='video/webm' src='"+recorded_video_data_url+"'></video>";
        new_window.document.write(inner_video_html);
        // window.open(recorded_video_data_url);
        // }).catch(function(error) {
        //     console.error('previewRecording failure', error);
        // });
        document.getElementById(stop_button_id).disabled = true;
        document.getElementById(start_button_id).disabled = false;
    }, false);
}

var global_time_remaining = null;

function startGlobalQuizTimer(time_in_minutes, time_in_seconds=0) {

    function time_remaining(endtime) {
        var t = Date.parse(endtime) - Date.parse(new Date());
        global_time_remaining = t;
        var seconds = Math.floor((t / 1000) % 60);
        var minutes = Math.floor((t / 1000 / 60) % 60);
        var hours = Math.floor((t / (1000 * 60 * 60)) % 24);
        var days = Math.floor(t / (1000 * 60 * 60 * 24));
        return {
            'total': t,
            'days': days,
            'hours': hours,
            'minutes': minutes,
            'seconds': seconds
        };
    }

    function run_clock(id, endtime) {
        var clock = document.getElementById(id);

        function update_clock() {
            var t = time_remaining(endtime);

            hours = t.hours;
            if(hours<10){
                hours="0"+hours;
            }

            minutes = t.minutes;
            if(minutes<10){
                minutes="0"+minutes;
            }

            seconds = t.seconds;
            if(seconds<10){
                seconds="0"+seconds;
            }

            clock.innerHTML = "<h5>Time remaining: "+ hours + ":" + minutes + ':' + seconds + "</h5>";
            if (t.total <= 0) {
                clearInterval(timeinterval);
            }

            if (t.hours<=0 && t.minutes <= 0 && t.seconds <= 0) {
                sync_remaining_time();
                setTimeout(end_test(true),3000);
            }
        }
        update_clock(); // run function once at first to avoid delay
        var timeinterval = setInterval(update_clock, 1000);
    }

    // var time_in_minutes = time_in_minutes;
    var current_time = Date.parse(new Date());
    var deadline = new Date(current_time + time_in_minutes * 60 * 1000 + time_in_seconds * 1000);
    $("#global-clockdiv").remove();
    $("#global-row-div-clock-div").html(`<div id="global-clockdiv" class="center"></div>`);
    run_clock('global-clockdiv', deadline);
}

var is_face_analysis_required = true;

if (window.location.pathname.indexOf("/applicant/quiz-paper") != -1) {
    if (performance.navigation.type == 1) {
        window.location = "/applicant/dashboard";
    } else {
        is_quiz_started = false;
        urlparams = getUrlVars();
        if ("disabled" in urlparams && urlparams["disabled"] == "true") {
            is_face_analysis_required = false;
        }

        $(document).bind("keydown", disableF5);
        render_quiz_config();
        $(window).bind('beforeunload', function() {
            sync_remaining_time();
        });
    }
} else {
    $(document).unbind("keydown", disableF5);
}

function render_quiz_config() {

    quiz_uuid = window.location.pathname.split("/")[3];

    $.ajax({
        url: '/applicant/get-quiz-config/',
        type: 'GET',
        data: {
            quiz_uuid: quiz_uuid
        },
        success: function(response) {
            if (response["status_code"] == 200) {
                if (is_quiz_started == false || 1) {

                    if (response["remaining_time"] == -1) {
                        startGlobalQuizTimer(response["time"]);
                    } else {
                        var seconds = Math.floor(response["remaining_time"] / 1000);
                        var minutes = Math.floor(seconds/60);
                        seconds -= minutes * 60;
                        startGlobalQuizTimer(minutes, seconds);
                    }

                    //if (is_face_analysis_required == true) {
                        initializeCaptureVideo("global-video-captured-response", "global-canvas-video-capture", "btn-start-recording", "btn-stop-recording", "btn-preview-recording", false, false, false);
                        startGlobalVideoCapture();
                    //}

                    startSyncTimeTimer();
                    is_quiz_started = true;
                }

                quiz_sections = response["quiz_section"];
                quiz_id = response["quiz_uuid"];

                var quiz_config_html = "";
                for (var i = 0; i < quiz_sections.length; i++) {
                    quiz_config_html += '\
                            <div class="col s12 m4 l4">\
                              <div class="card">\
                                <div class="card-content black-text">\
                                <span class="card-title">' + quiz_sections[i]["topic_name"] + '</span>\
                                    <hr>\
                                    <p>No questions: ' + quiz_sections[i]["no_questions"] + '</p>\
                                    <p>Time: ' + quiz_sections[i]["time"] + ' mins</p>\
                                    <p>Type: ' + quiz_sections[i]["category"] + '</p>\
                                    <p>Weightage: ' + quiz_sections[i]["weightage"] + ' %</p>\
                                </div>\
                                <div class="card-action">';

                    if (quiz_sections[i]["is_completed"] == true) {
                        quiz_config_html += '<a href="javascript:void(0)" class="btn safe" onclick="start_quiz_section_paper(this, \'' + quiz_id + '\', \'' + quiz_sections[i]["id"] + '\')"\
                                        id="btn-start-quiz-section-' + quiz_sections[i]["id"] + '" disabled="disabled">\
                                            <i class="material-icons inline-icon">lock</i>\
                                        </a>';
                        if(quiz_sections[i]['message']=='Completed'){
                            quiz_config_html += '<span class="green-text">Completed</span>';
                        }
                        else if(quiz_sections[i]['message']=='Pending'){
                            quiz_config_html += '<span class="red-text">Pending</span>';
                        }
                    } else {
                        quiz_config_html += '<a href="javascript:void(0)" class="btn safe" onclick="start_quiz_section_paper(this, \'' + quiz_id + '\', \'' + quiz_sections[i]["id"] + '\')"\
                                        id="btn-start-quiz-section-' + quiz_sections[i]["id"] + '">\
                                            <i class="material-icons inline-icon">lock_open</i> Start Now\
                                        </a>';
                    }

                    quiz_config_html += '</div>\
                                                  </div>\
                                                </div>';
                }

                document.getElementById("div-quiz-section-list").innerHTML = quiz_config_html;
            } else {
                window.location = "/";
            }
        },
        error: function(xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
}


function start_quiz_section_paper(element, quiz_uuid, quiz_section_id) {
    takeScreenShot();
    sync_remaining_time();
    clearInterval(sync_time_min_counter_timeout);
    $("#problem-render-preloader").show();
    $("#div-quiz-section-list").hide();
    $.ajax({
        url: '/applicant/get-quiz-section/',
        type: 'GET',
        data: {
            quiz_uuid: quiz_uuid,
            quiz_section_id: quiz_section_id
        },
        success: function(response) {
            console.log(response);
            if (response["status_code"] == 200) {
                last_attempted_quiz_section_id = quiz_section_id;
                if(response['is_sectional_timed']){
                    if (response["time_remaining"] == -1) {
                        startGlobalQuizTimer(response["time"]);
                    } else {
                        var seconds = Math.floor((response["time_remaining"]) / 1000);
                        var minutes = Math.floor(seconds/60);
                        seconds -= minutes * 60;
                        console.log(minutes, seconds);
                        startGlobalQuizTimer(minutes, seconds);
                    }
                }
                startSyncTimeTimer();
                totalProblems = response["total_problems"];
                problemCounter = response["no_questions_attempted"];
                fetch_problem(response);
            } else {
                window.location = "/";
            }
            $("#problem-render-preloader").hide();
            $("#div-quiz-section-list").show();
        },
        error: function(xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
}

function initializeCaptureAudio() {
    // Store a reference of the preview video element and a global reference to the recorder instance
    audio = document.getElementById('audio-captured-response');

    // When the user clicks on start video recording
    document.getElementById('btn-start-audio-recording').addEventListener("click", function() {
        // Disable start recording button
        this.disabled = true;

        // Request access to the media devices
        navigator.mediaDevices.getUserMedia({
            audio: true,
            video: false
        }).then(function(stream) {
            // Display a live preview on the video element of the page
            setSrcObject(stream, audio);

            // Start to display the preview on the video element
            // and mute the video to disable the echo issue !
            audio.play();
            audio.muted = true;

            // Initialize the recorder
            recorder = new RecordRTCPromisesHandler(stream, {
                mimeType: 'audio/webm',
                bitsPerSecond: 128000
            });

            audioStarted = true;

            // Start recording the video
            recorder.startRecording().then(function() {
                console.info('Recording audio ...');
            }).catch(function(error) {
                console.error('Cannot start audio recording: ', error);
            });

            // release stream on stopRecording
            recorder.stream = stream;
            startSpeechToText(this);

            // Enable stop recording button
            document.getElementById('btn-stop-audio-recording').disabled = false;
        }).catch(function(error) {
            console.error("Cannot access media devices: ", error);
        });
    }, false);

    // When the user clicks on Stop video recording
    document.getElementById('btn-stop-audio-recording').addEventListener("click", function() {
        this.disabled = true;

        recorder.stopRecording().then(function() {
            console.info('stopRecording success');

            // Retrieve recorded video as blob and display in the preview element
            audioBlob = recorder.blob;

            audioStopped = true;

            // video.src = URL.createObjectURL(videoBlob);
            // video.play();

            // Unmute video on preview
            // video.muted = false;

            // Stop the device streaming
            recorder.stream.stop();
            stopSpeechToText(this);

            // Enable record button again !
            document.getElementById('btn-start-audio-recording').disabled = false;