(function($) {
    $(function() {
        $('.sidenav').sidenav();
        $('.dropdown-trigger').dropdown({
            constrainWidth: false,
            alignment: 'left'
        });
        $('.collapsible').collapsible();
        $('.modal').modal();
        $('.tabs').tabs();
        $('select').select2({
            width: "100%"
        });
        $('.slider').slider();
        $('.tooltipped').tooltip({
            position: 'top'
        });
        $('.datepicker').datepicker({
            format: "dd/mm/yyyy"
        });
        $('.fixed-action-btn').floatingActionButton();
        $(".readable-pro-tooltipped").tooltip({
            position: "top"
        });
    }); // end of document ready
})(jQuery); // end of jQuery name space

$(window).keyup(function(e){
      if(e.keyCode == 44){
        $("body").hide();
      }

});

/*--------------------------
    preloader
---------------------------- */
$(window).on('load', function() {
    var pre_loader = $('#global-preloader');
    pre_loader.fadeOut('slow', function() {
        $(this).remove();
    });
});

function showGlobalPreloader() {
    $("#global-preloader").show(500);
}

function hideGlobalPreloader() {
    $("#global-preloader").hide(500);
}

function getCsrfToken() {
    var CSRF_TOKEN = $('input[name="csrfmiddlewaretoken"]').val();
    return CSRF_TOKEN;
}

function validateEmail(email) {
    var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(String(email).toLowerCase());
}

function showToast(message, duration) {
    M.toast({
        "html": message
    }, duration);
}

function hideChoiceDiv() {
    $("#div-problem-choices").hide();
    $("#div-problem-correct-choices").hide();
}

function showChoiceDiv() {
    $("#div-problem-choices").show();
    $("#div-problem-correct-choices").show();
    hideDescriptiveDiv();
}

function showDescriptiveDiv() {
    $("#div-problem-solution").show();
    $("#div-problem-hint").show();
    hideChoiceDiv();
}

function hideDescriptiveDiv() {
    $("#div-problem-solution").hide();
    $("#div-problem-hint").hide();
}
function isANumber(str) {
    return !/\D/.test(str);
}

function getEmbedVideoURL(url) {
    var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    var match = url.match(regExp);

    if (match && match[2].length == 11) {
        return "https://www.youtube.com/embed/" + match[2];
    } else {
        return url;
    }
}

function scrollToGivenElementId(element_id) {
    $('html, body').animate({
        scrollTop: $("#" + element_id).offset().top - 100
    }, 500);
}

function focusAtGivenElementID(element_id) {
    $("#" + element_id).focus();
}

function isCanvasBlank(canvas) {
    var blank = document.createElement('canvas');
    blank.width = canvas.width;
    blank.height = canvas.height;

    return canvas.toDataURL() == blank.toDataURL();
}

function showProfileRegisterCardPanel() {
    $("#profile-register-card-panel").show();
    $("#profile-verification-card-panel").hide();
    capturePictureInit();
}

function showProfileVerificationCardPanel() {
    $("#profile-register-card-panel").hide();
    $("#profile-verification-card-panel").show();
}



$(document).on("click", "#btn-profile-verify", function(e) {

    var applicantEmailId = $("#input-student-verification-emailid").val();
    if (validateEmail(applicantEmailId) == false) {
        showToast("Please enter valid email id.");
        scrollToGivenElementId("input-student-verification-emailid");
        focusAtGivenElementID("input-student-verification-emailid");
        return;
    }

    var applicantPhoneNumber = $("#input-student-verification-phone-number").val();
    if (applicantPhoneNumber.length != 10) {
        showToast("Please enter valid 10 digit mobile number");
        scrollToGivenElementId("input-student-verification-phone-number");
        focusAtGivenElementID("input-student-verification-phone-number");
        return;
    }

    url = "/applicant/verify?phone_number=" + applicantPhoneNumber + "&email_id=" + applicantEmailId;

    $.ajax({
        url: url,
        type: "GET",
        data: {

        },
        success: function(response) {
            if (response["status_code"] == 200) {
                if (response["is_registered"] == false) {
                    showProfileRegisterCardPanel();
                    $("#input-student-emailid").val(applicantEmailId);
                    $("#input-student-phonenumber").val(applicantPhoneNumber);
                } else {
                    showToast("Account already registered");
                }
            } else {
                console.log("Please report this error: " + response["status_message"]);
            }
        },
        error: function(xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
});

function capturePictureInit() {

    video = document.getElementById('video');
    canvas = document.getElementById('canvas-profile-pic');
    const snap = document.getElementById("snap");
    // const errorMsgElement = document.querySelector('span#errorMsg');

    const constraints = {
        audio: false,
        video: {
            width: 150,
            height: 150
        }
    };

    // Access webcam
    async function init() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            handleSuccess(stream);
        } catch (e) {
            alert("Sorry! You will not be able to capture your image with webcam. Please upload it from your devide.");
            // errorMsgElement.innerHTML = `navigator.getUserMedia error:${e.toString()}`;
        }
    }

    // Success
    function handleSuccess(stream) {
        window.stream = stream;
        video.srcObject = stream;
    }

    // Load init
    init();

    // Draw image
    var context = canvas.getContext('2d');
    context.clearRect(0, 0, canvas.width, canvas.height);
    context.restore();
    snap.addEventListener("click", function() {
        context.drawImage(video, 0, 0, 150, 150);
    });
}
$(document).on("change", "#input_profile_image", function(e) {
    var imageLoader = document.getElementById('input_profile_image');
    var canvas = document.getElementById('canvas-profile-pic');
    var ctx = canvas.getContext('2d');
    var reader = new FileReader();
    reader.onload = function(event) {
        var img = new Image();
        img.onload = function() {
            width = 150;
            height = 150;
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
        }
        img.src = event.target.result;
    }
    reader.readAsDataURL(imageLoader.files[0]);
    // $("#upload-profile-pic").show();
});

function is_proof_of_id_required() {
    if ($("#input-student-selected-id-proof-type").length == 1) {
        return true;
    }
    return false;
}

function isPANNumber(panVal) {
    var regpan = /^([a-zA-Z]){5}([0-9]){4}([a-zA-Z]){1}?$/;
    if (regpan.test(panVal)) {
        return true;
    } else {
        return false;
    }
}

$(document).on("click", "#btn-signup", function(e) {

    var canvas = document.getElementById("canvas-profile-pic");
    if (isCanvasBlank(canvas)) {
        showToast("Please capture your photo.");
        scrollToGivenElementId("canvas-profile-pic");
        focusAtGivenElementID("canvas-profile-pic");
        return;
    }

    var applicantImage = canvas.toDataURL("image/png");

    var applicantName = $("#input-student-name").val();
    if (applicantName == "") {
        showToast("Name can not be empty.");
        scrollToGivenElementId("input-student-name");
        focusAtGivenElementID("input-student-name");
        return;
    }

    var applicantEmailId = $("#input-student-emailid").val();
    if (validateEmail(applicantEmailId) == false) {
        showToast("Please enter valid email id.");
        scrollToGivenElementId("input-student-emailid");
        focusAtGivenElementID("input-student-emailid");
        return;
    }

    var applicantPhoneNumber = $("#input-student-phonenumber").val();
    if (applicantPhoneNumber.length != 10) {
        showToast("Please enter valid 10 digit mobile number");
        scrollToGivenElementId("input-student-phonenumber");
        focusAtGivenElementID("input-student-phonenumber");
        return;
    }

    var applicantDOB = $("#input-student-dob").val();
    if (applicantDOB == "") {
        showToast("Please enter valid date of birth");
        scrollToGivenElementId("input-student-dob");
        focusAtGivenElementID("input-student-dob");
        return;
    }

    var applicantCollegeName = $("#input-student-college-name").val();
    if (applicantCollegeName == "") {
        showToast("Please enter college name");
        scrollToGivenElementId("input-student-college-name");
        focusAtGivenElementID("input-student-college-name");
        return;
    }

    var applicantYearOfPassing = $("#input-student-year-of-passing").val();
    if (applicantYearOfPassing == "") {
        showToast("Please enter year of passing");
        scrollToGivenElementId("input-student-year-of-passing");
        focusAtGivenElementID("input-student-year-of-passing");
        return;
    }

    var applicantHiringProcess = null;
    // var applicantHiringProcess = $("#input-student-selected-process").val();
    // if(applicantHiringProcess==""){
    //     showToast("Please select division");
    //     scrollToGivenElementId("input-student-selected-process");
    //     focusAtGivenElementID("input-student-selected-process");
    //     return;
    // }

    var applicantStream = $("#input-student-stream").val();
    if (applicantStream == "") {
        showToast("Please enter your stream");
        scrollToGivenElementId("input-student-stream");
        focusAtGivenElementID("input-student-stream");
        return;
    }

    var applicantPercentage = $("#input-student-percentage").val();
    if (applicantPercentage == "") {
        showToast("Please enter your percentage");
        scrollToGivenElementId("input-student-percentage");
        focusAtGivenElementID("input-student-percentage");
        return;
    }

    var applicantResume = $("#input_profile_resume").val();
    if (applicantResume == "") {
        showToast("Please provide your resume.");
        scrollToGivenElementId("input_profile_resume");
        focusAtGivenElementID("input_profile_resume");
        return;
    }

    /*var is_id_proof_required = is_proof_of_id_required();

    var type_of_id_proof = null;
    var proof_id_number = null;
    if (is_id_proof_required == true) {

        selected_type_proof_id = $("#input-student-selected-id-proof-type").val();
        if (selected_type_proof_id == null) {
            showToast("Please profile valid proof id.");
            return;
        }

        id_proof_number = $("#input-student-id-proof-number").val();
        if (selected_type_proof_id == 1 && (id_proof_number.length != 12 || isANumber(id_proof_number) == false)) {
            showToast("Please enter valid 12 digit Aadhar Number.", 2000);
            return;
        }
        if (selected_type_proof_id == 2 && isPANNumber(id_proof_number) == false) {

            showToast("Please enter valid PAN Number.", 2000);
            return;
        }

        type_of_id_proof = selected_type_proof_id;
        proof_id_number = id_proof_number;
    }*/

    id_proof_adhaar_number = $("#input-student-id-proof-adhaar-number").val();
        if ((id_proof_adhaar_number.length != 12 || isANumber(id_proof_adhaar_number) == false)) {
            showToast("Please enter valid 12 digit Aadhar Number.", 2000);
            return;
        }
        id_proof_pan_number = $("#input-student-id-proof-pan-number").val();
        if(id_proof_pan_number !=""){
            if (isPANNumber(id_proof_pan_number) == false) {

                showToast("Please enter valid PAN Number.", 2000);
                return;
            }
        }

    var applicantCategory = $("#input-category").val();
    var applicantLocation = document.getElementById("input-walkin-location").value;
    if(applicantCategory == "2"){
        if(applicantLocation == ""){
            showToast("Please enter your location.", 2000);
            return;
        }
    }
    if (applicantResume == "") {
        showToast("Please provide your category.");
        scrollToGivenElementId("input-category");
        focusAtGivenElementID("input-category");
        return;
    }

    json_string = JSON.stringify({
        "applicant_image": applicantImage,
        "applicant_name": applicantName,
        "applicant_emailid": applicantEmailId,
        "applicant_phonenumber": applicantPhoneNumber,
        "applicant_dob": applicantDOB,
        "applicant_college": applicantCollegeName,
        "applicant_year_of_passing": applicantYearOfPassing,
        "applicant_stream": applicantStream,
        "applicant_percentage": applicantPercentage,
        "applicant_hiring_process_id": applicantHiringProcess,
        "applicant_category":applicantCategory,
        "is_id_proof_required": is_id_proof_required,
        "type_of_id_proof": type_of_id_proof,
        "proof_id_number": proof_id_number,
        "applicantLocation":applicantLocation
    });


    console.log(json_string)

    profileResume = ($("#input_profile_resume"))[0].files[0];
    formdata = new FormData();
    formdata.append('file', profileResume);
    formdata.append('data', json_string);

    var CSRF_TOKEN = getCsrfToken();
    $.ajax({
        url: "/applicant/signup",
        type: "POST",
        headers: {
            'X-CSRFToken': CSRF_TOKEN
        },
        data: formdata,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response["status_code"] == 200) {
                window.location = "/applicant/signup/success";
            } else if (response["status_code"] == 405) {
                showToast("Account already exists", 2000);
            } else {
                showToast("Unable to register your details, Please try again later.", 200);
            }
        },
        error: function(xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
});

$(document).on("click", "#btn-login", function(e) {
    var inputUserUsername = $("#input-student-username").val();
    var inputUserPassword = $("#input-student-password").val();

    if (inputUserUsername == "" || inputUserUsername.length != 10) {
        showToast("Please enter valid 10 digit phone number");
        return;
    }

    if (inputUserPassword == "") {
        showToast("Please enter valid password");
        return;
    }

    var CSRF_TOKEN = getCsrfToken();
    json_string = JSON.stringify({
        "username": inputUserUsername,
        "password": inputUserPassword
    });

    $.ajax({
        url: "/authenticate-applicant/",
        type: "POST",
        headers: {
            'X-CSRFToken': CSRF_TOKEN
        },
        data: {
            data: json_string
        },
        success: function(response) {
            // hideGlobalPreloader();
            if (response["status_code"] == 200) {
                window.location = "/applicant/dashboard";
            } else if (response["status_code"] == 405) {
                showToast("Looks like you do not have account registered with us. Please complete your registration.", 2000);
            } else {
                showToast("Invalid phone number or password.", 2000);
            }
        },
        error: function(xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
});

$(document).on("click", "#btn-employee-login", function(e) {
    var inputUserUsername = $("#input-employee-username").val();
    var inputUserPassword = $("#input-employee-password").val();

    var CSRF_TOKEN = getCsrfToken();
    json_string = JSON.stringify({
        "username": inputUserUsername,
        "password": inputUserPassword
    });
    $.ajax({
        url: "/authenticate-administrator/",
        type: "POST",
        headers: {
            'X-CSRFToken': CSRF_TOKEN
        },
        data: {
            data: json_string
        },
        success: function(response) {
            if (response["status_code"] == 200) {
                window.location = "/administrator/manage-applicants/";
            } else if (response["status_code"] == 405) {
                showToast("Unauthorized User", 2000);
            } else {
                showToast("Invalid username or password.", 2000);
            }
        },
        error: function(xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
});

$(document).on("click", "#btn-start-test-paper", function(e) {
    // $("#check-system-error").hide();
    // if(document.getElementById("checkbox-video-checked").checked==true && document.getElementById("checkbox-audio-checked").checked==true && is_video_checked==true && is_audio_checked==true){
    unique_quiz_id = window.location.pathname.split("/")[3];
    redirect_url = "/applicant/quiz-paper/" + unique_quiz_id;
    // disable_face_analysis = document.getElementById("checkbox-switch-off-face-analytics").checked;
    disable_face_analysis = true
    if (disable_face_analysis == true) {
        redirect_url += "?disabled=true";
    }
    window.location = redirect_url;
    // }else{
    //     $("#check-system-error").show();
    // }
});
